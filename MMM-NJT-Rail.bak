/* eslint-disable no-undef,guard-for-in,no-restricted-syntax */
// eslint-disable-next-line no-undef
Module.register("MMM-NJT-Rail", {
  defaults: {
    station: 'NY',
    fadePoint: .25,
    maxShown: 0,
    refreshInterval: 60,
  },
  start: function () {
    console.log = Log.log
    console.error = Log.error
    Log.log(`Starting module: ${this.name}`);
  },
  getDom: function () {
    let wrapper = document.createElement("div")
    wrapper.className = "BaseWrapper"
    wrapper.id = "wrapper"
    let t = document.createElement("table");
    t.id = "station_table"
    t.className = "normal fa-sm njtr_table"
    t.innerText = "loading..."

    wrapper.append(t)
    return wrapper
  },
  getStyles() {
    return ["default.css", "font-awesome.css"];
  },

  getScripts() {
    return [];
  },

  getTranslations() {
    return false;
  },
  notificationReceived: function (notification, payload, sender) {
    switch (notification) {
        this.sendSocketNotification("INIT_NJT", {
          station: this.config.station,
          max: this.config.maxShown,
          refresh: this.config.refreshInterval * 1000,
        })
        break
    }
  },
  socketNotificationReceived: function (notification, payload) {
    Log.log(notification)
    Log.log(payload)
    switch (notification) {
      case "REFRESH":
        if (this.config.fadePoint < 0) {
          this.config.fadePoint = 0;
        }
        var startingPoint = payload.length * this.config.fadePoint;
        var steps = payload.length - startingPoint;

        var tbl = document.getElementById("station_table")
        tbl.className = "small";
        var tblBody = document.createElement("tbody");
        tblBody.className = "njtr_table"
        if (payload.length === 0) {
          tbl.innerHTML = "No Trains Scheduled"
          tbl.className = "normal fa-sm"
          break;
        }

        this.insertHeader(tblBody)

         var createCell = this.createCell

        payload.forEach(function (train, i) {
          let row = document.createElement("tr")
          row.className = "normal fa-sm";

          row.appendChild(createCell(train.time, "njtr_time"));
          row.appendChild(createCell(train.dest, "njtr_dest"));
          row.appendChild(createCell(train.track, "njtr_track"));
          row.appendChild(createCell(train.line, "njtr_line"));
          row.appendChild(createCell(train.status, "njtr_status"));

          tblBody.appendChild(row);
          if (i >= startingPoint) {
            const currentStep = i - startingPoint;
            row.style.opacity = 1 - (1 / steps * currentStep);
          }
          tblBody.appendChild(row);

          tbl.innerHTML = '';
          tbl.appendChild(tblBody)
        })
        break
    }
  },
  insertHeader(table) {
    let row = document.createElement("tr")
    row.className = "normal fa-sm";

    row.appendChild(this.createCell("Time", "njtr_time"))
    row.appendChild(this.createCell("Destination", "njtr_dest"))
    row.appendChild(this.createCell("Track", "njtr_track"))
    row.appendChild(this.createCell("Line", "njtr_line"))
    row.appendChild(this.createCell("Status", "njtr_status"))

    table.appendChild(row);

    return table
  },
  createCell(text, className) {
    let cell = document.createElement("td")

    cell.innerText = text
    cell.className = "normal fa-sm " + className

    return cell
  }
})
